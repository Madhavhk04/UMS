{% extends "base.html" %}

{% block title %}Placements - University Management System{% endblock %}
{% block page_title %}Placement Portal{% endblock %}

{% block content %}
<div class="placements-page">
    <!-- Eligibility Status -->
    <div class="eligibility-banner">
        <div class="banner-content">
            <i class="fas fa-check-circle"></i>
            <div>
                <h3>You are eligible for {{ eligible_drives|length }} placement drives</h3>
                <p>Your CGPA: {{ "%.2f"|format(student.cgpa or 0.0) }} | Keep up the good work!</p>
            </div>
        </div>
    </div>

    <!-- Eligible Placement Drives -->
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-rocket"></i> Eligible Placement Drives</h2>
            <p>Companies you can apply to based on your CGPA</p>
        </div>

        {% if session.user_type == 'admin' %}
        <div class="admin-actions-bar" style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="openAddDriveModal()">
                <i class="fas fa-plus"></i> Add New Placement Drive
            </button>
        </div>
        {% endif %}

        {% if eligible_drives %}
        <div class="drives-grid">
            {% for drive in eligible_drives %}
            <div class="drive-card eligible">
                <div class="drive-header">
                    <div class="company-logo">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="company-info">
                        <h3>{{ drive.company_name }}</h3>
                        <p class="position">{{ drive.position }}</p>
                    </div>
                    <span class="eligible-badge">
                        <i class="fas fa-check"></i> Eligible
                    </span>
                </div>

                <div class="drive-details">
                    <div class="detail-row">
                        <i class="fas fa-calendar"></i>
                        <span><strong>Drive Date:</strong> {{ drive.drive_date }}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-graduation-cap"></i>
                        <span><strong>Eligibility:</strong> {{ drive.eligibility_criteria }}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-chart-line"></i>
                        <span><strong>Min CGPA:</strong> {{ drive.min_cgpa }}</span>
                    </div>
                </div>

                <div class="drive-footer">
                    <span class="status-badge status-{{ drive.status|lower }}">{{ drive.status }}</span>
                    <div class="action-buttons">
                        <button class="btn btn-info btn-sm" data-id="{{ drive.id }}"
                            data-company="{{ drive.company_name|e }}" data-position="{{ drive.position|e }}"
                            data-description="{{ drive.description|default('', true)|e }}"
                            onclick="openApplyModal(this, true, false)">
                            <i class="fas fa-info-circle"></i> Info
                        </button>
                        <button class="btn btn-primary btn-sm" data-id="{{ drive.id }}"
                            data-company="{{ drive.company_name|e }}" data-position="{{ drive.position|e }}"
                            data-description="{{ drive.description|default('', true)|e }}"
                            onclick="openApplyModal(this, false, true)">
                            <i class="fas fa-paper-plane"></i> Apply Now
                        </button>
                        {% if session.user_type == 'admin' %}
                        <a href="{{ url_for('admin_delete_drive', drive_id=drive.id) }}" class="btn btn-danger btn-sm"
                            onclick="return confirm('Are you sure you want to delete this drive?')">
                            <i class="fas fa-trash"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-search"></i>
            <h3>No eligible drives at the moment</h3>
            <p>Check back later for new opportunities</p>
        </div>
        {% endif %}
    </div>

    <!-- Registered Placement Drives -->
    {% if registered_drives %}
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-check-double"></i> Registered Drives</h2>
            <p>Drives you have successfully registered for</p>
        </div>

        <div class="drives-grid">
            {% for drive in registered_drives %}
            <div class="drive-card registered">
                <div class="drive-header">
                    <div class="company-logo">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="company-info">
                        <h3>{{ drive.company_name }}</h3>
                        <p class="position">{{ drive.position }}</p>
                    </div>
                    <span class="eligible-badge" style="background-color: #3b82f6;">
                        <i class="fas fa-registered"></i> Registered
                    </span>
                </div>

                <div class="drive-details">
                    <div class="detail-row">
                        <i class="fas fa-calendar"></i>
                        <span><strong>Drive Date:</strong> {{ drive.drive_date }}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-clock"></i>
                        <span><strong>Registered On:</strong> {{ drive.registration_date }}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-info-circle"></i>
                        <span><strong>Status:</strong> {{ drive.reg_status }}</span>
                    </div>
                </div>

                <div class="drive-footer">
                    <span class="status-badge status-{{ drive.status|lower }}">{{ drive.status }}</span>
                    <div class="action-buttons">
                        <button class="btn btn-info btn-sm" data-id="{{ drive.id }}"
                            data-company="{{ drive.company_name|e }}" data-position="{{ drive.position|e }}"
                            data-description="{{ drive.description|default('', true)|e }}"
                            onclick="openApplyModal(this, true, true)">
                            <i class="fas fa-info-circle"></i> Info
                        </button>
                        <button class="btn btn-secondary btn-sm" disabled>
                            <i class="fas fa-check"></i> Applied
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- All Upcoming Drives -->
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-list"></i> All Upcoming Drives</h2>
            <p>Complete list of scheduled placement drives</p>
        </div>

        <div class="drives-table-container">
            <table class="drives-table">
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Position</th>
                        <th>Eligibility</th>
                        <th>Drive Date</th>
                        <th>Status</th>
                        <th>Your Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for drive in all_drives %}
                    <tr class="{% if drive.min_cgpa <= student.cgpa %}eligible-row{% endif %}">
                        <td>
                            <strong>{{ drive.company_name }}</strong>
                        </td>
                        <td>{{ drive.position }}</td>
                        <td>{{ drive.eligibility_criteria }}</td>
                        <td>
                            <i class="fas fa-calendar"></i>
                            {{ drive.drive_date }}
                        </td>
                        <td>
                            <span class="status-badge status-{{ drive.status|lower }}">
                                {{ drive.status }}
                            </span>
                        </td>
                        <td>
                            {% if drive.min_cgpa <= student.cgpa %} <span class="badge-eligible">
                                <i class="fas fa-check-circle"></i> Eligible
                                </span>
                                {% else %}
                                <span class="badge-not-eligible">
                                    <i class="fas fa-times-circle"></i> Not Eligible
                                </span>
                                {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Companies Visited -->
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-briefcase"></i> Recent Companies Visited</h2>
            <p>Companies that have visited campus recently</p>
        </div>

        <div class="companies-grid">
            {% for company in companies %}
            <div class="company-card">
                <div class="company-badge">
                    <i class="fas fa-building"></i>
                </div>
                <div class="company-content">
                    <h3>{{ company.company_name }}</h3>
                    <p class="position-title">{{ company.position }}</p>
                    <div class="company-meta">
                        <span class="package">
                            <i class="fas fa-dollar-sign"></i>
                            {{ company.package }}
                        </span>
                        <span class="visit-date">
                            <i class="fas fa-calendar"></i>
                            {{ company.visit_date }}
                        </span>
                    </div>
                    {% if company.description %}
                    <p class="company-desc">{{ company.description }}</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Placement Statistics -->
    <div class="section">
        <div class="section-header">
            <h2><i class="fas fa-chart-pie"></i> Placement Statistics</h2>
            <p>Quick overview of placement season</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-building"></i>
                </div>
                <div class="stat-info">
                    <h3>50+</h3>
                    <p>Companies Visited</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3>85%</h3>
                    <p>Placement Rate</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-info">
                    <h3>$92K</h3>
                    <p>Average Package</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="stat-info">
                    <h3>$150K</h3>
                    <p>Highest Package</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Apply Modal -->
    <div id="applyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalCompanyName">Company Name</h3>
                <span class="close-modal" onclick="closeApplyModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p class="modal-position"><strong id="modalPosition">Position</strong></p>
                <div class="modal-description">
                    <h4>Job Description</h4>
                    <p id="modalDescription">Description goes here...</p>
                </div>
                <div class="modal-confirmation" id="modalConfirmationMessage">
                    <p><i class="fas fa-exclamation-circle"></i> Are you sure you want to register for this drive?</p>
                </div>
            </div>
            <div class="modal-footer">
                <form action="{{ url_for('apply_drive') }}" method="POST" id="applyForm">
                    <input type="hidden" name="drive_id" id="modalDriveId">
                    <button type="button" class="btn btn-secondary" onclick="closeApplyModal()">Close</button>
                    <button type="submit" class="btn btn-primary" id="confirmButton">Confirm Registration</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Drive Modal (Admin) -->
    {% if session.user_type == 'admin' %}
    <div id="addDriveModal" class="modal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%);">
                <h3>Add New Placement Drive</h3>
                <span class="close-modal" onclick="closeAddDriveModal()">&times;</span>
            </div>
            <form action="{{ url_for('admin_add_drive') }}" method="POST">
                <div class="modal-body">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Company Name</label>
                        <input type="text" name="company_name" required class="form-control"
                            style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Position</label>
                        <input type="text" name="position" required class="form-control"
                            style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Eligibility Criteria</label>
                        <input type="text" name="eligibility" required class="form-control"
                            style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    </div>
                    <div class="grid-form"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Drive Date</label>
                            <input type="date" name="drive_date" required class="form-control"
                                style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        </div>
                        <div class="form-group">
                            <label>Min CGPA</label>
                            <input type="number" step="0.1" name="min_cgpa" required class="form-control"
                                style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" rows="4" class="form-control"
                            style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddDriveModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Drive</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
    function openApplyModal(element, isInfoOnly, isRegisteredOrEligible) {
        var id = element.getAttribute('data-id');
        var company = element.getAttribute('data-company');
        var position = element.getAttribute('data-position');
        var description = element.getAttribute('data-description');

        document.getElementById('modalDriveId').value = id;
        document.getElementById('modalCompanyName').innerText = company;
        document.getElementById('modalPosition').innerText = position;
        // Handle newlines in description for display
        document.getElementById('modalDescription').innerHTML = (description || 'No description available.').replace(/\n/g, '<br>');

        var confirmBtn = document.getElementById('confirmButton');
        var confirmMsg = document.getElementById('modalConfirmationMessage');

        if (isInfoOnly) {
            confirmBtn.style.display = 'none';
            confirmMsg.style.display = 'none';
        } else {
            confirmBtn.style.display = 'inline-block';
            confirmMsg.style.display = 'flex';
        }

        document.getElementById('applyModal').style.display = 'block';
    }

    function closeApplyModal() {
        document.getElementById('applyModal').style.display = 'none';
    }

    function openAddDriveModal() {
        document.getElementById('addDriveModal').style.display = 'block';
    }

    function closeAddDriveModal() {
        document.getElementById('addDriveModal').style.display = 'none';
    }

    // Update close modal if clicked outside
    window.onclick = function (event) {
        var applyModal = document.getElementById('applyModal');
        var addModal = document.getElementById('addDriveModal');
        if (event.target == applyModal) {
            applyModal.style.display = "none";
        }
        if (event.target == addModal) {
            addModal.style.display = "none";
        }
    }
</script>

<style>
    .btn-danger {
        background: #ef4444;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.3s;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .form-control:focus {
        border-color: #4361ee;
        outline: none;
        box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
    }

    .eligibility-banner {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .banner-content {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .banner-content i {
        font-size: 48px;
    }

    .banner-content h3 {
        font-size: 24px;
        margin-bottom: 5px;
    }

    .banner-content p {
        font-size: 14px;
        opacity: 0.9;
    }

    .section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .section-header {
        margin-bottom: 25px;
    }

    .section-header h2 {
        font-size: 24px;
        margin-bottom: 8px;
        color: #333;
    }

    .section-header p {
        color: #666;
        font-size: 14px;
    }

    .drives-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }

    .drive-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        border: 2px solid #e0e0e0;
        transition: all 0.3s;
    }

    .drive-card.eligible {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .drive-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .drive-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }

    .company-logo {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        flex-shrink: 0;
    }

    .company-info {
        flex: 1;
    }

    .company-info h3 {
        font-size: 18px;
        margin-bottom: 3px;
        color: #333;
    }

    .position {
        color: #667eea;
        font-size: 14px;
        font-weight: 600;
    }

    .eligible-badge {
        background: #10b981;
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
    }

    .drive-details {
        margin-bottom: 20px;
    }

    .detail-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid #e0e0e0;
        font-size: 14px;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-row i {
        color: #667eea;
        width: 20px;
    }

    .drive-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .status-badge {
        padding: 5px 15px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-open {
        background: #d1fae5;
        color: #065f46;
    }

    .status-upcoming {
        background: #dbeafe;
        color: #1e40af;
    }

    .drives-table-container {
        overflow-x: auto;
    }

    .drives-table {
        width: 100%;
        border-collapse: collapse;
    }

    .drives-table thead {
        background: #f8f9fa;
    }

    .drives-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e0e0e0;
    }

    .drives-table td {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
    }

    .eligible-row {
        background: #f0fdf4;
    }

    .badge-eligible {
        color: #10b981;
        font-weight: 600;
        font-size: 14px;
    }

    .badge-not-eligible {
        color: #ef4444;
        font-weight: 600;
        font-size: 14px;
    }

    .companies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }

    .company-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        border: 2px solid #e0e0e0;
        transition: all 0.3s;
    }

    .company-card:hover {
        border-color: #667eea;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }

    .company-badge {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
        margin-bottom: 15px;
    }

    .company-content h3 {
        font-size: 20px;
        margin-bottom: 5px;
        color: #333;
    }

    .position-title {
        color: #667eea;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .company-meta {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
    }

    .package,
    .visit-date {
        font-size: 13px;
        color: #666;
    }

    .package i,
    .visit-date i {
        color: #667eea;
        margin-right: 5px;
    }

    .company-desc {
        color: #666;
        font-size: 13px;
        margin-top: 10px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .stat-card {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
    }

    .stat-info h3 {
        font-size: 28px;
        margin-bottom: 5px;
        color: #333;
    }

    .stat-info p {
        font-size: 14px;
        color: #666;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-state i {
        font-size: 60px;
        color: #cbd5e1;
        margin-bottom: 20px;
    }

    .empty-state h3 {
        font-size: 24px;
        margin-bottom: 10px;
        color: #333;
    }

    .empty-state p {
        color: #666;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 0;
        border: 1px solid #888;
        width: 50%;
        max-width: 600px;
        border-radius: 12px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 20px;
    }

    .close-modal {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
    }

    .close-modal:hover {
        color: #e0e0e0;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-position {
        font-size: 18px;
        color: #333;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .modal-description {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        max-height: 200px;
        overflow-y: auto;
    }

    .modal-description h4 {
        margin-top: 0;
        font-size: 16px;
        color: #4b5563;
        margin-bottom: 10px;
    }

    .modal-description p {
        color: #666;
        font-size: 14px;
        line-height: 1.6;
    }

    .modal-confirmation {
        color: #d97706;
        background: #fffbeb;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #fcd34d;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #eee;
        text-align: right;
        background: #f9fafb;
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-right: 10px;
        transition: 0.3s;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }

    .btn-info {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.3s;
    }

    .btn-info:hover {
        background: #2563eb;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
    }

    .drive-card.registered {
        border-color: #3b82f6;
        background: #eff6ff;
    }
</style>
{% endblock %}